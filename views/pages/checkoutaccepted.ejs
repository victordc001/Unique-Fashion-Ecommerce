 

 <!DOCTYPE html>
 <html lang="en">
 <head>
        
    <%- include('../partials/head.ejs') %> 
     <title>Checkout</title>
 </head> 

   <style>
     .acard{
         width:100%; 
         padding-left:20px;
         padding-right:20px; 
         padding-top:20px;
         padding-bottom:20px;
         border:1px solid #008080;
     }    

     
     .gridda {
  display: grid;
  grid-row-gap: 40px;
  grid-column-gap: 40px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 2fr)); /* Use auto-fill */
  margin: 0 10px;    
  padding: 0 10px; 
  box-sizing: border-box; 
}
   </style>
 <body>   

    <%- include('../partials/topbar.ejs') %>  

    <!-- Page Header Start -->
    <div class="container-fluid mb-5 headerimg">
     <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
         <h1 class="font-weight-semi-bold text-uppercase mb-3" style="color:white">ACCEPTED ORDERS</h1>
         <div class="d-inline-flex">
             <p class="m-0"><a style="color:#fff; font-weight:bold; font-size:18px;" href="/">Home</a></p>
             <p  class="m-0 px-2">-</p>
             <p style="color:white; font-size:18px;" class="m-0">Accepted Orders</p>
         </div>
     </div>
 </div> <br><br>
 <!-- Page Header End -->
  
     <h1 style="text-align:center; padding-left:20px; padding-right:20px;">Checkout Accepted Orders</h1>   <br> <br> 
      
     <% if(orderDoc.length > 0) { %> 
        <div class="gridda"> 
       <% orderDoc.forEach((order)=>{ %>  
      <div class="acard">  
        <% let theTotalPayment = 0; %>   
     <ul> 
         <% order.cartDetails.forEach(item => { %>
             <li><%= item.productName %>: <b>Â£<%= parseFloat(item.totalPrice).toFixed(2) %></b> (Quantity: <%= item.quantity %>, Size: <%= item.size %>)</li>
              <% }); %>  
              <li>Shipping Fee: <b> <%=order.shippingFee%></b></li>  <br>  
        </ul>   

       <% theTotalPayment += parseFloat(order.shippingFee) %> <!-- Add shipping fee once -->

       <% order.cartDetails.forEach(item => { %>
        <% theTotalPayment += parseFloat(item.totalPrice); %> <!-- Add total prices of items -->
    <% }); %>  

      <p>Total Payment: <b>Â£<%= theTotalPayment.toFixed(2) %></b></p> 

     <form class="processPayment" totalpayment = '<%=theTotalPayment%>'>
         <input type="hidden" name="userId" value="<%= order.customer %>">
         <input type="hidden" name="orderId" value="<%= order._id %>"> 
         <div style="width:100%; text-align:center"> 
          <button style="background-color:#008080; padding:10px; color:white; border:none" type="submit">Proceed to Payment</button>
          </div>
        </form> 
     <div style="width:100%; text-align:center"> 
     <button class="removeord" style="background-color:red; color:white; padding:10px; margin-top:5px; border:none" orderId="<%= order._id %>" > Cancel Order</button>   
       </div> 

    </div>   
        
     <% }); %>   
      </div>
     <% } else {%>
            <p style="text-align:center; font-family:'Poppins', sans-serif">Hi <%=user.reguser%>, You have no Accepted Order yet, please come back laterðŸ™‚</p>
        <% } %>

       
    <%- include('../partials/footer.ejs') %> 

         <script>
                 const forms = document.querySelectorAll('.processPayment');
  
     forms.forEach(dform => {
    dform.addEventListener('submit', async (e) => { 
         
        const userId = dform.querySelector('input[name="userId"]').value;  
        const orderId = dform.querySelector('input[name="orderId"]').value;   
        const dbtn = dform.querySelector('button'); 
        const totalpayment= dform.getAttribute('totalpayment');
        dbtn.innerHTML = 'Processing..';
        dbtn.style.opacity = 0.45; 

        var allbutton = document.querySelectorAll('button');
       allbutton.forEach((each)=>{
         each.disabled = true;
       });


        e.preventDefault();  
           
        try {
            const resp = await fetch(`/payment/${userId}/${orderId}`, {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                },
                body: JSON.stringify({ totalpayment }), // add the shipping fee.  
            });

            if (!resp.ok) {
                throw resp;
            }    

           setTimeout(()=>{
            dbtn.innerHTML = 'Loading Url..';
        dbtn.style.opacity = 0.45; 
    }, 2000); 
        
               const result = await resp.json(); 
               const url = result.paymenturl;   
              setTimeout( ()=>{window.location.href = url;}, 3500);

        } catch (err) {
            const error = await err.text();
            alert(error);    
            dbtn.innerHTML = 'Proceed to Payment';
        dbtn.style.opacity = 4;
        var allbutton = document.querySelectorAll('button');
       allbutton.forEach((each)=>{
         each.disabled = false;
       });

        }
    });  
    
});   


//delete order 
  var remove = document.querySelectorAll('.removeord');
  remove.forEach((each)=>{ 
    each.addEventListener('click', async (e)=>{ 
      var orderId = each.getAttribute('orderId');  


      e.preventDefault();   
      var confirmer = confirm('Are you sure you want to cancel this order?');
      if(!confirmer) { 
          return;
      }     


       var allbutton = document.querySelectorAll('button');
       allbutton.forEach((each)=>{
         each.disabled = true;
       });

        
       each.innerHTML = 'cancelling..';
       each.style.opacity = 0.45; 

        
           try {
               const resp = await fetch(`/delete_an_orderr/${orderId}`, {
                   method: 'delete',  
               });
   
               if (!resp.ok) {
                   throw resp;
               }   

               setTimeout(()=>{
        each.innerHTML = 'cancelled';
       each.style.opacity = 5; 
       }, 2000); 

       setTimeout(()=>{  
        location.reload();
  }, 3500);  

           } catch (err) {
               const error = await err.text();
               alert(error);    
               each.innerHTML = 'Cancel Order';
              each.style.opacity = 4;
              var allbutton = document.querySelectorAll('button');
       allbutton.forEach((each)=>{
         each.disabled = false;
       });  
           } 
    });

  });  

 
    


  

         </script> 

 </body>
 </html>
 